# Implementation Plan: Phase 1-3 Improvements for splurge-sql-generator 2025.5.0

**Date:** October 18, 2025  
**Version:** 2025.5.0  
**Branch:** `feature/phase-1-3-implementation`  
**Status:** In Progress

---

## Overview

This document details the implementation plan for Phase 1-3 improvements recommended in the research document. The implementation is divided into three phases with specific deliverables for each.

---

## Phase 1: High-Impact, Low-Risk (Duration: ~2.5 hours)

### 1.1: Extract SQL Type Mappings (1 hour)
**Objective:** Remove duplication in SQL type mappings between `_get_default_mapping()` and `generate_types_file()`

**Tasks:**
1. ✅ Create module-level constant `_DEFAULT_SQL_TYPE_MAPPING` in `schema_parser.py`
2. Refactor `_get_default_mapping()` to return copy of constant
3. Refactor `generate_types_file()` to use constant instead of duplicating mappings
4. Add unit tests to verify no functional change
5. Run mypy and pytest to validate

**Files Modified:**
- `splurge_sql_generator/schema_parser.py`

**Acceptance Criteria:**
- Single source of truth for SQL type mappings
- No duplication between methods
- All existing tests pass
- mypy returns 0 errors

---

### 1.2: Expand Exception Hierarchy (1 hour)
**Objective:** Add specific exception classes for better error categorization

**Tasks:**
1. ✅ Add new exception classes to `exceptions.py`:
   - `ParsingError` (base for parsing-specific errors)
   - `SqlParsingError` (sqlparse failures)
   - `TokenizationError` (token processing)
   - `SchemaError` (schema processing)
   - `ColumnDefinitionError` (column parsing)
   - `TypeInferenceError` (type mapping)
   - `ConfigurationError` (config issues)
   
2. Update docstrings with clear semantics
3. Run mypy and pytest to validate

**Files Modified:**
- `splurge_sql_generator/exceptions.py`

**Acceptance Criteria:**
- New exception classes follow naming conventions
- Exception hierarchy is logical and documented
- Base class `SplurgeSqlGeneratorError` is preserved for backwards compatibility
- All existing tests pass
- mypy returns 0 errors

---

### 1.3: Add InputValidator (30 mins)
**Objective:** Centralize input validation with fail-fast approach

**Tasks:**
1. Create `InputValidator` class in `utils.py` with static methods:
   - `sql_file_path(path)` - validates .sql file exists
   - `sql_content(content)` - validates non-empty SQL
   - `identifier(name, context)` - validates Python identifier
   
2. Update `sql_parser.py` and `code_generator.py` to use validator
3. Add unit tests
4. Run mypy and pytest to validate

**Files Modified:**
- `splurge_sql_generator/utils.py`
- `splurge_sql_generator/sql_parser.py` (1-2 call sites)
- `splurge_sql_generator/code_generator.py` (1-2 call sites)

**Acceptance Criteria:**
- Consistent validation across codebase
- Clear, actionable error messages
- All existing tests pass
- mypy returns 0 errors

---

## Phase 2: Medium-Impact, Medium-Risk (Duration: ~6-7 hours)

### 2.1: Create FileIoAdapter (2 hours)
**Objective:** Abstract file I/O for testability and reduced exception boilerplate

**Tasks:**
1. Create abstract base class `FileIoAdapter` in new file `splurge_sql_generator/file_utils.py`:
   - `read_text(path, encoding)` abstract method
   - `write_text(path, content, encoding)` abstract method
   - `exists(path)` abstract method
   
2. Create `SafeTextFileIoAdapter(FileIoAdapter)` implementation wrapping `SafeTextFileReader/Writer`
   - Translate SafeIo exceptions to `FileError`
   - Add logging for all operations
   
3. Update `schema_parser.py` to use adapter (optional for Phase 2, required for Phase 3)
4. Add unit tests for adapter
5. Run mypy and pytest to validate

**Files Modified:**
- `splurge_sql_generator/file_utils.py` (new)
- Tests may need updates for dependency injection

**Acceptance Criteria:**
- FileIoAdapter is testable with mock implementations
- SafeIo exceptions properly translated
- Exception details preserved in FileError
- All existing tests pass
- mypy returns 0 errors

---

### 2.2: Create YamlConfigReader (1.5 hours)
**Objective:** Consolidate YAML loading with centralized error handling

**Tasks:**
1. Create `YamlConfigReader` class in `file_utils.py`:
   - `__init__(file_io: FileIoAdapter | None)` - use provided adapter or default
   - `read(path)` - read YAML with centralized error handling
   
2. Update `schema_parser._load_sql_type_mapping()` to use reader
3. Add comprehensive error handling tests
4. Run mypy and pytest to validate

**Files Modified:**
- `splurge_sql_generator/file_utils.py` (extends Phase 2.1)
- `splurge_sql_generator/schema_parser.py` (simplifies _load_sql_type_mapping)

**Acceptance Criteria:**
- Reduced exception handling code in schema_parser
- Centralized YAML parsing logic
- Clear error messages for YAML failures
- Graceful fallback to default mappings
- All existing tests pass
- mypy returns 0 errors

---

### 2.3: Create Typed Data Structures (2 hours)
**Objective:** Type-safe data structures for method/column/table information

**Tasks:**
1. Create new file `splurge_sql_generator/types.py` with TypedDict definitions:
   - `ColumnInfo` - column name, sql_type, python_type, nullable
   - `MethodInfo` - method name, sql_type, python_type, parameters, is_fetch, statement_type, has_returning
   - `TableDefinition` - table_name, columns, schema
   
2. Update function signatures in `sql_parser.py` and `code_generator.py` to return/accept TypedDict
3. Update code that constructs these structures
4. Add unit tests verifying type safety
5. Run mypy and pytest to validate

**Files Modified:**
- `splurge_sql_generator/types.py` (new)
- `splurge_sql_generator/sql_parser.py` (return types)
- `splurge_sql_generator/code_generator.py` (method signatures)

**Acceptance Criteria:**
- TypedDict structures provide IDE autocomplete
- All function signatures updated
- Type annotations clear and consistent
- mypy reports 0 errors
- All existing tests pass

---

### 2.4: Refactor Token Processing (2-3 hours)
**Objective:** Simplify token navigation and CTE scanning

**Tasks:**
1. In `sql_helper.py`:
   - Create helper function `get_next_significant_token()` returning `tuple[int, Token] | tuple[None, None]`
   - Create helper function `_filter_tokens()` with predicate support
   - Create helper function `extract_identifier_name()` for quoted identifier extraction
   
2. Create `CteScannerState` enum
3. Create `CteScanner` class to encapsulate CTE scanning logic
   - Extract from `find_main_statement_after_with()` logic
   - Make testable independently
   
4. Update `detect_statement_type()` to use `CteScanner`
5. Add unit tests for new helpers
6. Run mypy and pytest to validate

**Files Modified:**
- `splurge_sql_generator/sql_helper.py`

**Acceptance Criteria:**
- Token processing code is less deeply nested
- CTE scanning is separate and testable
- Less duplication in token filtering
- All existing tests pass
- mypy returns 0 errors

---

## Phase 3: Lower-Priority Improvements (Duration: ~10-15 hours)

### 3.1: Add Error Recovery (2-3 hours)
**Objective:** Implement graceful degradation with comprehensive error recovery

**Tasks:**
1. Add try-except with fallback logic in `schema_parser.load_schema()`
2. Add logging for recovery actions
3. Create `generate_partial_schema()` method for partial recovery
4. Add unit tests for recovery paths
5. Run mypy and pytest to validate

**Files Modified:**
- `splurge_sql_generator/schema_parser.py`

---

### 3.2: Add Bounds Checking (2-3 hours)
**Objective:** Handle large files gracefully

**Tasks:**
1. Implement chunked processing for files larger than `MAX_MEMORY_MB`
2. Add `_parse_sql_file_chunked()` method in `sql_helper.py`
3. Add bounds checking in `split_sql_file()`
4. Add tests for large file handling
5. Run mypy and pytest to validate

**Files Modified:**
- `splurge_sql_generator/sql_helper.py`

---

### 3.3: Enhance Test Coverage (3-5 hours)
**Objective:** Increase coverage of error paths and edge cases

**Tasks:**
1. Add tests for all error paths in new exception classes
2. Test fallback logic (regex after sqlparse)
3. Test edge cases (empty input, unicode, special characters)
4. Test concurrent access scenarios
5. Add integration tests for end-to-end workflows
6. Run pytest with coverage: `pytest --cov=splurge_sql_generator --cov-report=term-missing`

**Files Modified:**
- Multiple test files

---

### 3.4: Configuration Management (2 hours)
**Objective:** Create structured configuration

**Tasks:**
1. Create `config.py` with `GeneratorConfig` dataclass
2. Add `from_env()` class method
3. Update code to use config object
4. Add tests for configuration loading
5. Run mypy and pytest to validate

**Files Modified:**
- `splurge_sql_generator/config.py` (new)
- Core modules updated to use config

---

### 3.5: Improve Logging (1 hour)
**Objective:** Consistent logging across all modules

**Tasks:**
1. Review all modules for logging coverage
2. Ensure consistent log levels (DEBUG, INFO, WARNING, ERROR)
3. Add missing log statements at key decision points
4. Add tests verifying log output

**Files Modified:**
- All core modules

---

### 3.6: Performance Optimization (2-3 hours)
**Objective:** Add caching and performance improvements

**Tasks:**
1. Profile code paths with large files
2. Add LRU caches to frequently called functions
3. Add performance benchmarks
4. Document performance characteristics

**Files Modified:**
- `splurge_sql_generator/sql_helper.py`
- Other high-traffic modules

---

## Testing Strategy

### Unit Testing
- Each module modified gets comprehensive unit tests
- Test both happy paths and error conditions
- Use fixtures for common setup
- Aim for 85%+ coverage per module

### Integration Testing
- Test interactions between modules (sql_parser → schema_parser → code_generator)
- Test end-to-end workflows
- Test with real files

### Validation
- Run `mypy splurge_sql_generator` - must return 0 errors
- Run `ruff check .` - must return 0 errors
- Run `pytest -v` - all tests must pass
- Run `pytest --cov=splurge_sql_generator` - assess coverage impact

---

## Implementation Order

### Week 1: Phase 1 (Complete by Day 2)
1. Extract SQL Type Mappings
2. Expand Exception Hierarchy
3. Add InputValidator
4. Run all tests, validate mypy/ruff

### Week 1-2: Phase 2 (Complete by Day 5-6)
1. Create FileIoAdapter
2. Create YamlConfigReader
3. Create Typed Data Structures
4. Refactor Token Processing
5. Run all tests, validate mypy/ruff

### Week 2-3: Phase 3 (Complete by Day 12-15)
1. Add Error Recovery
2. Add Bounds Checking
3. Enhance Test Coverage
4. Configuration Management
5. Improve Logging
6. Performance Optimization

---

## Risks & Mitigations

| Risk | Severity | Mitigation |
|------|----------|-----------|
| Breaking existing APIs | Medium | Keep old methods as deprecated wrappers for 1 version |
| Test failures after refactoring | Medium | Run tests after each phase, fix immediately |
| Type annotations incomplete | Low | Use mypy strict mode, review all public methods |
| Performance regression | Low | Profile before/after each optimization, benchmark key paths |

---

## Success Criteria

After Phase 1:
- ✅ Code duplication reduced
- ✅ Better error categorization
- ✅ Consistent input validation
- ✅ All tests pass
- ✅ mypy reports 0 errors

After Phase 2:
- ✅ Testable file I/O abstraction
- ✅ Centralized configuration reading
- ✅ Type-safe data structures
- ✅ Simplified token processing
- ✅ All tests pass
- ✅ mypy reports 0 errors

After Phase 3:
- ✅ Graceful error recovery
- ✅ Large file handling
- ✅ >90% test coverage
- ✅ Structured configuration
- ✅ Consistent logging
- ✅ Performance benchmarks
- ✅ All tests pass
- ✅ mypy reports 0 errors

---

## References

- Research Document: `docs/research/research-2025.5.0-simplification.md`
- Copilot Instructions: `.github/instructions/copilot-instructions.md`
- Current Code: `splurge_sql_generator/` package

---

**Document Status:** Final  
**Last Updated:** October 18, 2025  
**Next Milestone:** Phase 1 Completion (by Oct 20, 2025)
